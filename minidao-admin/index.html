<body id="iwnb">
<meta charset="UTF-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<link
        href="https://cdn.jsdelivr.net/npm/daisyui@4.10.5/dist/full.min.css"
        rel="stylesheet"
        type="text/css"
/>
<link href="./output.css" rel="stylesheet"/>
<link
        href="https://cdn.jsdelivr.net/npm/toastify-js/src/toastify.min.css"
        rel="stylesheet"
        type="text/css"
/>
<main
        class="pt-20 bg-base-100 flex flex-col items-center gap-10"
        data-theme="dark"
        style="min-height: 800px"
>
    <p class="text-white text-3xl">MiniDAO - Admin panel</p>
    <div class="card w-96 bg-neutral shadow-xl" id="tab-4">
        <div class="px-10 pt-10">
            <button class="btn" onclick="my_modal_1.showModal()">Read info</button>
            <dialog id="my_modal_1" class="modal">
                <div class="modal-box">
                    <h3 class="font-bold text-lg">Info about token!</h3>
                    <p class="py-4">Please be advised that token allocation among addresses can currently be
                        executed only once. Any additional issuance of tokens will be subject to
                        a voting process. As an initial distributor, you have the capability to
                        allocate a significant number of tokens to yourself and manually
                        distribute the rest to other participants. This initial distribution is
                        crucial and must be carefully planned as subsequent emissions cannot be
                        guaranteed without collective agreement. Choose your allocations wisely
                        to align with your strategic objectives and ensure a fair distribution
                        process.</p>
                    <div class="modal-action">
                        <form method="dialog">
                            <!-- if there is a button in form, it will close the modal -->
                            <button class="btn">Close</button>
                        </form>
                    </div>
                </div>
            </dialog>
        </div>

        <form class="card-body flex flex-col space-y-4" id="token-form">
            <!-- Open the modal using ID.showModal() method -->

            <div class="flex flex-col gap-2">
                <label for="addresses">Addresses</label>
                <textarea
                        class="textarea textarea-bordered min-h-36 max-h-96"
                        id="addresses"
                        name="addresses"
                        placeholder="Enter addresses (each address on a new line)"
                ></textarea>

                <label for="amounts">Amounts</label>
                <textarea
                        class="textarea textarea-bordered min-h-36 max-h-96"
                        id="amounts"
                        name="amounts"
                        placeholder="Enter amounts (each amount on a new line)"
                ></textarea>
            </div>
            <button class="btn btn-primary">Mint</button>
        </form>
    </div>
</main>
<script
        src="https://cdn.ethers.io/lib/ethers-5.2.umd.min.js"
        type="application/javascript"
></script>

<script>
    const tokenABI = [
        "function tokenDistribution(address[] to, uint256[] amount)",
        "function name() view returns (string)",
        "function decimals() view returns (uint256)",
        "function balanceOf(address) view returns (uint256)",
    ];
    const superDAOABI = [
        "function governor() view returns (address)",
        "function myAddr() view returns (address)",
        "function timeLock() view returns (address)",
        "function token() view returns (address)",
        "function treasury() view returns (address)",
    ];

    let provider, wallet, contractDAO, contractToken;
    const privateKey =
        "0xac0974bec39a17e36ba4a6b4d238ff944bacb478cbed5efcae784d7bf4f2ff80";
    const contractAddress = "0x5FbDB2315678afecb367f032d93F642f64180aa3";

    async function connectToContract() {
        // forward
        // provider = new ethers.BrowserProvider(this.parent.ethereum);
        // signer = await provider.getSigner();
        // connectContract = new ethers.Contract(contractAddress, abi, signer);
        // console.log("Account:", await signer.getAddress());
        // forward

        provider = new ethers.providers.JsonRpcProvider(); // URL локальной сети блокчейна может потребоваться
        wallet = new ethers.Wallet(privateKey, provider);
        contractDAO = new ethers.Contract(contractAddress, superDAOABI, wallet);
        const tokenAddr = await contractDAO.token();
        contractToken = new ethers.Contract(tokenAddr, tokenABI, wallet);
        console.log("name:", await contractToken.name());
    }

    connectToContract().then(() => {
        console.log(wallet.address, contractDAO.address);
    });
</script>
<script
        src="https://cdn.jsdelivr.net/npm/toastify-js"
        type="text/javascript"
></script>
<script>
    const callCustomToast = (msg) => {
        Toastify({
            text: msg,
            gravity: "top", // `top` or `bottom`
            position: "center", // `left`, `center` or `right`
        }).showToast();
    };

    const tokenForm = document.getElementById("token-form");
    tokenForm.addEventListener("submit", async (e) => {
        e.preventDefault();
        const formData = new FormData(tokenForm);
        const addresses_input = formData.get("addresses");
        let addresses = addresses_input
            .split("\n")
            .map((address) => address.trim())
            .filter((address) => address.trim() !== "");
        //addresses = Array.from(new Set(addresses));

        const amounts_input = formData.get("amounts");

        const decimals = await contractToken.decimals();
        let amounts = amounts_input
            .split("\n")
            .map((amount) => amount.trim())
            .filter((amount) => amount.trim() !== "");

        amounts = amounts.map((amount) => {
            // Преобразование amount в строку, если это еще не строка
            let amountStr = amount.toString();

            // Создание строки для числа 10 в степени decimals
            let factorStr = "1" + "0".repeat(decimals);

            // Использование BigNumber из ethers.js для безопасной математической операции
            let result = ethers.BigNumber.from(amountStr).mul(
                ethers.BigNumber.from(factorStr)
            );

            // Преобразование результата обратно в строку
            return result.toString();
        });
        //amounts = Array.from(new Set(amounts));

        let error;

        addresses.forEach((address) => {
            if (!/^0x[a-fA-F0-9]{40}$/.test(address)) {
                error = true;
            }
        });

        if (error) {
            callCustomToast(`The field content contains invalid addresses!`);
        } else {
            // ethersjs code

            console.log(addresses, amounts);

            await contractToken.tokenDistribution(addresses, amounts);

            console.log(
                await contractToken
                    .balanceOf("0x3128ef7F0933cF2bA18f1Ef7280A7b684347B115")
                    .toString()
            );
            callCustomToast("All addresses minted successfully!");
            tokenForm.reset();
        }
    });
</script>
</body>
